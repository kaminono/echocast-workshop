# AGENTS.md
> Project: EchoCast Workshop — AI 播客策划助手  
> Purpose: 作为“面向机器的 README”，统一指导 Cursor（IDE/CLI/MCP）在任何阶段的**生成/修改/评审**行为；保持长期有效、可演进。

---

## 0) 项目愿景与不变约束（长期有效）
- **价值目标**：让播客从“点子 → 草稿 → 定稿 → 多语种 → 排期发布”形成可追溯、可协作、可复用的流水线。
- **领域不变式**
  - `Idea`（创意点子）**结构禁止变更**；允许补充索引/衍生视图，但**不可新增/删改字段**破坏兼容。
  - `FinalScript`（定稿）**版本化**（vN），每次定稿视为独立版本。
  - `LocaleVariant`（翻译）**绑定到具体的 FinalScript 版本**；**新版本不继承旧版本翻译**。
  - `Draft`（草稿）仅保留最新态，用于多轮打磨，不做历史版本存档（历史由 FinalScript 快照承担）。
- **合规与隐私**：严禁提交任何密钥/Token；只经 `.env*` / 密管注入读取；严禁把用户数据写入日志。

---

## 1) 环境与阶段开关（Dev/Stage/Prod 通用）
- **禁止在 Prod 使用 mock**；Dev/Stage 仅可在**明确的特性开关**与**可替换接口**（同名接口+假实现）下使用。
- **特性开关命名**：`FEATURE_*`；关闭即不加载代码路径（tree-shake 友好）。
- **灾难回退**：每条自动变更流程必须可关闭（开关/参数/CLI），并保留人工兜底路径。

---

## 2) 代码与风格（全仓库生效）
- **语言/类型**：TypeScript 全面启用；禁用 `any`（仅在边界适配层允许、并须补类型注释）。
- **目录约定**
  - `app/`（Next.js 路由/页面容器）
  - `components/`（纯视图组件，**无业务逻辑**）
  - `features/*`（特性域：drafts, finals, locales, timeline）
  - `services/`（编排/第三方调用；具重试/节流/容错）
  - `stores/`（轻量状态；跨组件共享）
  - `repositories/`（持久化与幂等写入）
  - `rules/`（提示词/策略文档与校验规范）
- **提交信息**：遵循 Conventional Commits；重要变更附带“动机/方案/影响”。

---

## 3) 领域模型与状态机（跨阶段一致）
- **核心模型**：`Idea` / `FinalScript(vN)` / `LocaleVariant` / `IdeaAsset`
- **翻译状态机**：`failed → translated → reviewed → scheduled → published`
  - `published` 不可删除；`scheduled` 先取消排期再删。
- **幂等键**：`LocaleVariant` 以 `(scriptId + locale)` 作为唯一键，统一走 `upsert`。
- **校验（UI + 服务双校验）**
  - `title ≤ 40`；`intro` 1–2 句；`bulletPoints ≤ 3`（每条 1 句）；`cta` 单句（动词开头）。
  - 溢出字段**截断且标注**（不静默丢弃）。

---

## 4) 生成/修改的工作流原则（Agent/CLI 通用）
- **最小入侵**：优先复用既有组件（按钮/弹窗/表单/卡片/徽标），避免引入新设计体系。
- **变更路径**：UI 触发 → 服务编排（并发/重试/节流）→ JSON 校验/裁剪 → 仓储 `upsert` → 状态推进。
- **版本守卫（VersionGuard）**
  - 切换到新 `FinalScript` 版本时，**清空翻译列表并提示“不继承”**。
  - 若检测到跨版本写入，**拒绝并提示**，引导用户在当前版本生成/校对。
- **错误处理**：**局部失败不影响整体**；逐语言可重试；所有失败必须可见（卡片内红框 + 日志）。

---

## 5) 第三方/模型接入与 MCP
- **模型/服务调用**：通过既有封装客户端调用（禁止直连 HTTP）；新增供应商时**走适配层**实现等价接口。
- **MCP（Model Context Protocol）**：用于把本地代码/数据库/API 暴露为可调工具；CLI 与编辑器使用**相同 MCP 配置**。  
  - 优先使用**工具化的纯函数接口**；每个工具声明清晰入参/出参；可记录到事件日志。  
  - 谨慎开启 auto-run；需要审批/白名单时在 MCP 配置中限制。  
- **外部文档索引**（可选）：接入权威文档以增强生成/审阅质量（保留来源与版本说明）。

---

## 6) 前端交互与可用性
- **表单行为**：“编辑/保存/删除/设为已审核/重试”按钮显隐必须与状态机一致；保存成功显示时间戳。
- **可访问性**：表单控件需有 ARIA 标签；错误提示文本可读；键盘可操作（Enter/ESC/Tab 正常）。
- **国际化**：UI 文案统一走 i18n 资源；用户生成内容的翻译走模型。

---

## 7) 持久化与日志
- **仓储层**：所有写入走 `repositories/*`；`upsert` 对幂等键生效；失败不污染历史数据。
- **审计**：记录最后操作人/时间、变更前后摘要（不落入隐私内容）；核心路径打点与错误聚合。
- **备份/迁移**：版本升级时遵循“向前兼容 + 有迁移脚本 + 可回滚”。

---

## 8) 测试与验收（DOD）
- **优先级**：类型检查 > 状态机边界 > 幂等写入 > 关键 UI 交互。
- **验收清单**（任何阶段通用抽测）
  - 新建 `FinalScript vN`：翻译列表为空并显示“旧翻译不继承”。
  - 批量生成多语种：允许某一语言失败且可单独重试；其他语言不受影响。
  - 编辑保存 → 状态 `translated`；置为已审核 → `reviewed`；`published` 不可删除。
  - 溢出字段就地提示并截断；日志可见幂等更新与错误聚合。

---

## 9) 与 Cursor 的配合约定
- **根目录放置**：`AGENTS.md` 位于仓库根目录，IDE 与 CLI 自动读取应用。  
- **Project Rules**：可在 `.cursor/rules/` 放更细的分区/按文件类型规则，与本文件**叠加**生效。  
- **CLI 脚本化**：在非交互/流水线中，优先使用 `--print --output-format json|stream-json` 获取结构化输出。  
- **Ask/Agent 切换**：理解代码用 Ask（不改代码）；批量改动与自动化用 Agent/CLI；必要时开启人工确认。