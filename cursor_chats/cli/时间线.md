# 提示词目标
在 EchoCast Workshop 中落地“**发布时间线（排期视图）**”相关功能，覆盖前后端与状态管理：
- **FinalScriptDetail（定稿详情）**：为当前版本 vN 设置/更新/清除“发布时间”，与 vN **强绑定**。
- **Timeline（时间线）**：按“发布时间”聚合展示所有 FinalScript vN，支持筛选/排序/跳详情。
- **全局时区**：新增 IANA 时区设置（可搜索），**持久化**，全站时间本地化渲染与联动。
- 系统规范：**UTC 存储、渲染本地**；**不修改 `Idea`**；复用现有 DB/连接；**严禁 mock**。

---

# 需求说明

## 1) 业务对象与约束
- 目标实体：`FinalScript`（定稿，**版本化 vN**）。
- 新增/对齐字段（若已有等价字段请复用）：
  - `publishAtUtc?: string`  // ISO 8601（如 `2025-09-05T21:00:00Z`）
  - `publishStatus?: 'unscheduled' | 'scheduled' | 'published' | 'paused'`（如已有状态体系则映射）
- **版本绑定**：`publishAtUtc` 与 **具体 vN** 强绑定；切换到新版本 vN+1 时，**不继承**旧版本发布时间。
- **可编辑性**：
  - `published`：只读，不允许修改发布时间（如需回溯，使用“清除并重新设置”策略，需二次确认）。
  - `scheduled/paused`：允许修改或清除（清除即回到 `unscheduled`）。
- **时间规范**：传输与存储一律 `UTC`；渲染时按“全局时区”转换为本地。

## 2) 定稿详情页（FinalScriptDetail）
- 顶部信息区：显示“当前版本 vN”；若 `publishAtUtc` 为空 → **未设置**；否则显示“**本地时间 + 时区标签**”与 `publishStatus` 徽标。
- **PublishCard（发布时间卡片）**：
  - 控件：日期时间选择器（本地）；只读时区标签（来源于全局时区）。
  - 按钮：**保存**、**清除**。保存禁用条件：无改动/校验未通过/进行中。
  - 校验：默认不允许设置为过去时间（可通过 `ALLOW_PAST_PUBLISH=false` 常量控制；如为 true 仅给出提醒）。
  - 交互：保存成功 toast，并更新“最后更新时间”；清除操作二次确认。
  - 版本切换：切到 vN+1，如未设置发布时间，顶部出现“**新版本未设置发布时间**”提示。
- 与多语种翻译区域并列，互不影响。

## 3) 时间线页（Timeline）
- 视图：垂直时间轴（可先用“分组+列表”样式，日/周/月切换为可选增强）。
- 节点卡片：**标题（或摘要）｜版本 vN｜发布时间（本地）｜状态**；点击跳转至对应 **FinalScriptDetail vN**。
- 筛选：日期范围（本地）、状态（unscheduled/scheduled/published/paused）、关键词（标题包含）。
- 排序：升序/降序切换。
- 空态：无数据时显示引导（“去设置发布时间” → 跳最近定稿详情）。

## 4) 全局时区（IANA）
- 入口：Navbar“设置”或时间线右上角“时区”图标。
- 控件：可搜索的 IANA 时区下拉。
- **优先级**：用户选择 > 账户配置（如有） > 浏览器时区。
- **持久化**：`preferredTimezone` 保存至 `localStorage`（或 IndexedDB）；提供 `TimezoneProvider`（React Context）与 `useTimezone()` Hook。
- **联动**：切换时区后，FinalScriptDetail 与 Timeline **即时联动刷新**。
- **日期格式 i18n**：根据 UI 语言本地化（`zh-CN: YYYY-MM-DD`｜`en-US: MM/DD/YYYY`｜`ja-JP: YYYY/MM/DD`）。

## 5) 一致性与可观测
- **UTC 入库**：所有写入/查询以 `publishAtUtc`（UTC）为准。
- **冲突提示（展示层，可选）**：若同一时刻存在多个版本/多语言发布，可在时间线做“冲突高亮”提示（仅提示，不做写入阻断）。
- 审计：保存/清除动作记录操作者、时间与前后差异（复用既有日志机制）。

---

# 输出要求（代码产物）

## A. 前端
1) 组件与页面
- `FinalScriptDetail`：新增 **PublishCard**（日期时间选择器 + 保存/清除 + 时区只读标签）。
- `TimelinePage`：时间线列表 + 筛选条 + 节点卡片 + 点击跳详情 + 升/降序。
- `TimezoneProvider` + `useTimezone()`：全局时区上下文；提供 `getCurrentTimezone()`、`setTimezone(tz)`、`formatInTz(utc, tz, locale)`。
- **格式化工具**：`lib/time.ts` 暴露：
  - `toUtc(localDateTimeString, tz): string`（ISO Z）
  - `toLocal(utcString, tz, locale): { date: string, time: string }`
  - `formatDateTime(utcString, tz, locale): string`
  > 优先使用原生 `Intl.DateTimeFormat`；必要时可引入 `dayjs.tz`。

2) 交互与校验
- 保存流程：本地时间 + 全局时区 → `toUtc` → 调接口 → 成功刷新视图。
- 清除流程：置空 `publishAtUtc`，二次确认。
- 表单校验：空值/非法时间/过去时间（按常量开关）；错误就地提示（红框+文案）。
- 无副作用：保存失败不污染旧值；按钮显隐与 loading 态正确。

## B. API（复用现有服务与 DB；**不得 mock**）
- `PUT /final-scripts/:id/version/:v/publish`
  - body: `{ publishAtUtc: string | null }`
  - 功能：设置/更新/清除指定版本的 `publishAtUtc`；返回更新后的 FinalScript 片段（含 `publishAtUtc` 与 `updatedAt`）。
- `GET /timeline?from=YYYY-MM-DD&to=YYYY-MM-DD&status=...&q=...&sort=asc|desc&page=1&pageSize=50`
  - 返回：`{ range, items: [{ id, scriptId, version, title, publishAtUtc, status, updatedAt }], page, totalPages }`
  - 约束：按 `publishAtUtc` UTC 区间查询与分页；默认升序。

> 若项目已有控制器/仓储，请将以上接口映射到既有路径与风格，保持错误码/鉴权一致。

## C. 类型与存储
- `types/final.ts`：为 `FinalScript` 对齐或扩展 `publishAtUtc?: string`、`publishStatus?: ...`。
- `stores/timezone.ts`：读写 `preferredTimezone`；默认浏览器时区；向外暴露订阅/事件，页面收到更新后重渲染。
- `stores/timeline.ts`：保存筛选条件、分页信息、加载态与结果缓存（最近一次查询）。

## D. UI 文案（示例，i18n 支持）
- “未设置发布时间”
- “发布时间已保存”
- “发布时间已清除”
- “请选择一个有效时间”
- “当前时区：{{timezone}}（可在设置中修改）”
- “新版本未设置发布时间”

## E. 可访问性与状态
- 输入控件含 label/aria；键盘 Enter 保存 / Esc 取消。
- 保存/清除提供 toast 与可见状态变化；错误可复制说明。

---

# 验收标准（DOD）
- **设置/更新/清除**：在 FinalScript vN 页面完成发布时间设置，刷新后正确回显；清除有二次确认。
- **UTC 入库、本地渲染**：切换不同全局时区后，FinalScriptDetail 与 Timeline 显示时间**即时联动且正确**。
- **时间线展示**：按发布时间聚合，支持**日期范围/状态/关键词**筛选与**升/降序**切换；点击节点能跳回对应 vN。
- **版本不继承**：切到 vN+1 显示“新版本未设置发布时间”，旧时间不自动带入。
- **异常与稳健**：非法/过去时间（默认不允许）得出**明确提示**；保存失败不改旧值；日志可查（操作者/时间/前后差异）。
- **无 mock**：代码直接接入现有 DB/服务，类型检查通过，遵循项目错误码规范。

---

# 特别说明
- **禁止修改 `Idea` 结构**；仅在 `FinalScript` 维度实现发布时间绑定与展示。
- 统一样式与现有组件体系（圆角、按钮形态、表单风格）；**不要引入新设计系统**。
- 时间与格式**随语言本地化**：`zh-CN: YYYY-MM-DD`、`en-US: MM/DD/YYYY`、`ja-JP: YYYY/MM/DD`。
- 如需“过去时间”用于回填历史发布，请通过常量 `ALLOW_PAST_PUBLISH=true` 开启，并在 UI 明示“历史回填”。

